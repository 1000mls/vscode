pool: 1es-windows-2019-x64

steps:
  - task: NodeTool@0
    inputs:
      versionSource: fromFile
      versionFilePath: .nvmrc
      nodejsMirror: https://github.com/joaomoreno/node-mirror/releases/download

  - task: SFP.build-tasks.esrpclient-tools-task.EsrpClientTool@2
    displayName: "Use EsrpClient"

  - task: AzureKeyVault@1
    displayName: "Azure Key Vault: Get Secrets"
    inputs:
      azureSubscription: "vscode-builds-subscription"
      KeyVaultName: vscode-build-secrets
      SecretsFilter: "github-distro-mixin-password,esrp-aad-username,esrp-aad-password"

  - task: AzureKeyVault@1
    displayName: "Azure Key Vault: Get Secrets"
    inputs:
      azureSubscription: "vscode-builds-subscription"
      KeyVaultName: vscode-build-packages
      SecretsFilter: "vscode-esrp,c24324f7-e65f-4c45-8702-ed2d4c35df99"

  - pwsh: node build/npm/setupBuildYarnrc
    displayName: Prepare build dependencies

  - pwsh: yarn
    workingDirectory: build
    displayName: Install build dependencies

  - task: AzureCLI@2
    displayName: Fetch secrets
    inputs:
      azureSubscription: "vscode-builds-subscription"
      scriptType: pscore
      scriptLocation: inlineScript
      addSpnToEnvironment: true
      inlineScript: |
        Write-Host "##vso[task.setvariable variable=AZURE_TENANT_ID]$env:tenantId"
        Write-Host "##vso[task.setvariable variable=AZURE_CLIENT_ID]$env:servicePrincipalId"
        Write-Host "##vso[task.setvariable variable=AZURE_CLIENT_SECRET;issecret=true]$env:servicePrincipalKey"

  - pwsh: |
      $ErrorActionPreference = "Stop"
      $CertCollection = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2Collection
      $AuthCertBytes = [System.Convert]::FromBase64String("$(vscode-esrp)")
      $CertCollection.Import($AuthCertBytes, $null, [System.Security.Cryptography.X509Certificates.X509KeyStorageFlags]::Exportable -bxor [System.Security.Cryptography.X509Certificates.X509KeyStorageFlags]::PersistKeySet)
      $RequestSigningCertIndex = $CertCollection.Count
      $RequestSigningCertBytes = [System.Convert]::FromBase64String("$(c24324f7-e65f-4c45-8702-ed2d4c35df99)")
      $CertCollection.Import($RequestSigningCertBytes, $null, [System.Security.Cryptography.X509Certificates.X509KeyStorageFlags]::Exportable -bxor [System.Security.Cryptography.X509Certificates.X509KeyStorageFlags]::PersistKeySet)
      $CertStore = New-Object System.Security.Cryptography.X509Certificates.X509Store("My","LocalMachine")
      $CertStore.Open("ReadWrite")
      $CertStore.AddRange($CertCollection)
      $CertStore.Close()
      $AuthCertSubjectName = $CertCollection[0].Subject
      $RequestSigningCertSubjectName = $CertCollection[$RequestSigningCertIndex].Subject
      Write-Host "##vso[task.setvariable variable=RELEASE_AUTH_CERT_SUBJECT_NAME]$AuthCertSubjectName"
      Write-Host "##vso[task.setvariable variable=RELEASE_REQUEST_SIGNING_CERT_SUBJECT_NAME]$RequestSigningCertSubjectName"
    displayName: Import certificates

  - pwsh: node build/azure-pipelines/common/migrate.js
    env:
      GITHUB_TOKEN: "$(github-distro-mixin-password)"
      AZURE_TENANT_ID: "$(AZURE_TENANT_ID)"
      AZURE_CLIENT_ID: "$(AZURE_CLIENT_ID)"
      AZURE_CLIENT_SECRET: "$(AZURE_CLIENT_SECRET)"
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
      RELEASE_TENANT_ID: 975f013f-7f24-47e8-a7d3-abc4752bf346
      RELEASE_CLIENT_ID: c24324f7-e65f-4c45-8702-ed2d4c35df99
      RELEASE_AUTH_CERT_SUBJECT_NAME: "$(RELEASE_AUTH_CERT_SUBJECT_NAME)"
      RELEASE_REQUEST_SIGNING_CERT_SUBJECT_NAME: "$(RELEASE_REQUEST_SIGNING_CERT_SUBJECT_NAME)"
      PROVISION_TENANT_ID: 72f988bf-86f1-41af-91ab-2d7cd011db47
      PROVISION_AAD_USERNAME: "$(esrp-aad-username)"
      PROVISION_AAD_PASSWORD: "$(esrp-aad-password)"
      AZURE_DOCUMENTDB_ENDPOINT: https://vscode.documents.azure.com:443/
      PRSS_CDN_URL: https://vscode.download.prss.microsoft.com/dbazure/download
      PRSS_RELEASE_TENANT_ID: 975f013f-7f24-47e8-a7d3-abc4752bf346
      PRSS_RELEASE_CLIENT_ID: c24324f7-e65f-4c45-8702-ed2d4c35df99
      PRSS_PROVISION_TENANT_ID: 72f988bf-86f1-41af-91ab-2d7cd011db47
    displayName: Process artifacts
